<!--


‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñë‚ñë
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë
‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ïö‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë
‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñë‚ñë‚ñë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù


ùî∏ùï¶ùï•ùïñùï¶ùï£ : Elias Zaiem
ùîªùïíùï•ùïñ : 18.05.2022
‚Ñôùï£ùï†ùïõùïñùï• : TPI Elias Zaiem Mai-2022
‚Ñôùï£ùï†ùïó ùîªùïñ ùïã‚ÑôùïÄ : Mr.Garchery
‚ÑÇùïùùïíùï§ùï§ùïñ : I.DA-P4A
-->
<?php
/* Controleur si tout va bien lors du post*/

$action = filter_input(INPUT_GET, 'action');
switch ($action) {
        //Visuel de la page de Post
    case 'show':
        //Affiche le formulaire de post
        include 'vue/post_form.php';
        break;
    case 'validate':
        //R√©cup√©ration de la description et r√©cup√©ration du/des fichier(s)
        $fichier = $_FILES["filesPost"];
        $titreProduction = filter_input(INPUT_POST, 'titreProduction', FILTER_SANITIZE_STRING);
        $descriptionProduction = filter_input(INPUT_POST, 'descriptionProduction', FILTER_SANITIZE_STRING);
        $categorieProduction = filter_input(INPUT_POST, 'categorieProduction', FILTER_SANITIZE_STRING);


        //Si tout les champs sont remplis alors :
        if ($titreProduction != "" && $descriptionProduction != "" && $categorieProduction != "" && $fichier['name'][0] != "") {


            //V√©rification du type de fichier (si c'est bien une image ou non)
            if (explode("/", $fichier['type'][0])[0] != "image") {
                $_SESSION['AlertMessage'] = [
                    'type' => "danger",
                    'message' => "Seulement les images sont support√©es !"
                ];
                header('Location: index.php?uc=post&action=show');
            }

            $fileMo = Production::ConvertOctetsToMO($fichier['size'][0]);
            // v√©rifie la taille de chaque image afin de ne pas d√©pacer 5 Mo
            if ($fileMo > 5) {
                $_SESSION['AlertMessage'] = [
                    'type' => "danger",
                    'message' => "L'image ne doit pas d√©passer les 5 Mo !"
                ];
                header('Location: index.php?uc=post&action=show');
            }

            //R√©cup√®re la date du jour
            $currentDate = date("Y-m-d H:i:s");
            $dir = "./assets/medias/";

            // g√©n√®re un nom al√©atoire
            $randomName = Production::GenerateRandomImageName() . "." . explode("/", $fichier['type'][0])[1];

            // si le nom al√©atoire existe d√©j√†, on en reg√©n√®re un
            while (file_exists($dir . $randomName)) {
                $randomName = Production::GenerateRandomImageName() . "." . explode("/", $fichier['type'][0])[1];
            }

            if (move_uploaded_file($fichier['tmp_name'][0], $dir . $randomName)) {
                // on cr√©e la production dans la base de donn√©es
                $production = new Production();
                $production->setTitreProduction($titreProduction)
                    ->setDescriptionProduction($descriptionProduction)
                    ->setDate_soumission($currentDate)
                    ->setDate_modification($currentDate)
                    ->setFilename($randomName)
                    ->setCategories_idCategorie($categorieProduction)
                    ->setUser_idUser($_SESSION['connectedUser']['idUser']);
                Production::AddProduction($production);

                //Si le post √† √©t√© cr√©er, afficher un message de r√©ussite.
                $_SESSION['AlertMessage'] = [
                    'type' => "success",
                    'message' => "Vous avez post√© avec succ√®s !"
                ];
                header('Location: index.php?');
            } else {
                // retourne un message d'erreur si les champs ne sonts pas remplis
                $_SESSION['AlertMessage'] = [
                    'type' => "danger",
                    'message' => "L'image n'a pas pu √™tre publi√©  !"
                ];
                header('Location: index.php?uc=post&action=show');
            }
        } else {
            // retourne un message d'erreur si les champs ne sonts pas remplis
            $_SESSION['AlertMessage'] = [
                'type' => "danger",
                'message' => "Tout les champs doivent √™tres rempli  !"
            ];
            header('Location: index.php?uc=post&action=show');
        }
        break;

    case 'showDetail':
        $idPost = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_NUMBER_INT);
        $production = Production::GetProdutionById($idPost);
        include 'vue/postDetail.php';
        break;

    case 'like':
        $idPost = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_NUMBER_INT);
        $like = new LikeUnlike();
        $like->setLike(1)
            ->setUtilisateurs_idUser($_SESSION['connectedUser']['idUser'])
            ->setProduction_idProduction($idPost);
        $like->LikePost();

        $_SESSION['AlertMessage'] = [
            'type' => "success",
            'message' => "Vous avez lik√© le post"
        ];
        header('Location: index.php');
        break;

    case 'dislike':
        $idPost = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_NUMBER_INT);
        $like = new LikeUnlike();
        $like->setLike(2)
            ->setUtilisateurs_idUser($_SESSION['connectedUser']['idUser'])
            ->setProduction_idProduction($idPost);
        $like->LikePost();

        $_SESSION['AlertMessage'] = [
            'type' => "danger",
            'message' => "Vous avez dislik√© le post"
        ];
        header('Location: index.php');
        break;


    case 'editLikePost':
        $idProduction = filter_input(INPUT_GET, 'idProduction', FILTER_SANITIZE_NUMBER_INT);
        $numberLike = filter_input(INPUT_GET, 'like', FILTER_SANITIZE_NUMBER_INT);


        $like = new LikeUnlike();
        $like->setUtilisateurs_idUser($_SESSION['connectedUser']['idUser'])
            ->setProduction_idProduction($idProduction)
            ->setLike($numberLike);
        $like->EditLikePost();

        header('Location: index.php');
        break;

    case 'ShowMyProductions':
        //Affiche la page des productions publi√©es par l'utilisateur
        include 'vue/myProductions.php';
        break;

        //Suppression d'une production et de son m√©dia (image stock√©e en locale)
    case 'deleteProduction':
        $idProduction = filter_input(INPUT_GET, 'idProduction', FILTER_SANITIZE_NUMBER_INT);
        //Va chercher le m√©dia dans les assets et le supprime puis redirige vers la page Myproduction
        if (unlink("./assets/medias/" . Production::GetMediaNameByProductionId($idProduction))) {
            Production::DeleteProduction($idProduction);
        }
        //Message de r√©ussie
        $_SESSION['AlertMessage'] = [
            'type' => "success",
            'message' => "La production a bien √©t√© supprim√©e de la base de donn√©es !"
        ];
        //Redirige l'utilisateur puis affiche le message de r√©ussite
        header('Location: index.php?uc=production&action=ShowMyProductions');
        break;

    case 'ShowEditProductionPage':
        $idProduction = filter_input(INPUT_GET, 'idProduction', FILTER_SANITIZE_NUMBER_INT);
        $production = Production::GetProdutionById($idProduction);
        //Affiche la page des productions publi√©es par l'utilisateur
        include 'vue/editProduction.php';
        break;

    case 'editProduction':
        $idProduction = filter_input(INPUT_GET, 'idProduction', FILTER_SANITIZE_NUMBER_INT);
        $numberLike = filter_input(INPUT_GET, 'like', FILTER_SANITIZE_NUMBER_INT);


        $like = new LikeUnlike();
        $like->setUtilisateurs_idUser($_SESSION['connectedUser']['idUser'])
            ->setProduction_idProduction($idProduction)
            ->setLike($numberLike);
        $like->EditLikePost();

        header('Location: index.php');
        break;

    case 'UpdateProductionInfos':
        //Filtrage des donn√©es qui vont √™tre modifi√©es
        $titre = filter_input(INPUT_POST, 'titre', FILTER_SANITIZE_STRING);
        $description = filter_input(INPUT_POST, 'description', FILTER_SANITIZE_STRING);
        $categorie = filter_input(INPUT_POST, 'categorieProduction', FILTER_SANITIZE_EMAIL);
        $idProduction = $_GET['idProduction'];
        $date_modification = date("Y-m-d H:i:s");
        Production::UpdateProductionInfos($titre, $description, $categorie, $date_modification, $idProduction);
        //Message de r√©ussie
        $_SESSION['AlertMessage'] = [
            'type' => "success",
            'message' => "La production " . $titre . " a bien √©t√© modifi√© dans la base de donn√©es."
        ];
        //Redirection de l'utilisateur
        header('Location: index.php?uc=production&action=ShowMyProductions');

        break;

    default:
        include 'vue/erreur404.php'; // affiche la page d'erreur 404 si le lien n'est pas valide
        break;
}
